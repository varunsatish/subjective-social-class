### Calculating r-squared from bivariate regression of outcomes on each 
### individual variable

```{r}
library(tidyverse)
library(multidplyr)

directory_path <- "../"
data_path <- "/scratch/network/vs3041/subjective-social-class/cleaned_data/GSS_cross_section_clean.csv"
figure_save_path <- "/home/vs3041/subjective-social-class/figures/"

GSS_data <- read_csv(data_path, show_col_types = F)

# generating class indicators 
GSS_data <- GSS_data %>%
  mutate(
    class_1 = ifelse(class == 1, 1, 0),
    class_2 = ifelse(class == 2, 1, 0),
    class_3 = ifelse(class == 3, 1, 0),
    class_4 = ifelse(class == 4, 1, 0),
    
    class_1_2 = case_when(
      class == 1 ~ 0,
      class == 2 ~ 1
    ),
    class_2_3 = case_when(
      class == 2 ~ 0,
      class == 3 ~ 1
    ),
    class_3_4 = case_when(
      class == 3 ~ 0,
      class == 4 ~ 1
    ))

```

```{r}

# Function to calculate R-squared trends
return_r2_trends <- function(data, outcome_var, explanatory_variables) {
  # Individual variable regressions
  individual_results <- data %>%
    group_by(year) %>%
    crossing(explanatory_variable = explanatory_variables) %>%
    group_by(year, explanatory_variable) %>%
    summarize(
      r_squared = summary(lm(as.formula(paste(outcome_var, "~ factor(", explanatory_variable, ")", collapse=" ")), data = cur_group()))$r.squared,
      model_type = "individual",
      .groups = 'drop'
    )
  
  # All variables regression
  all_vars_formula <- paste(outcome_var, "~", paste("factor(", explanatory_variables, ")", collapse = " + "))
  full_results <- data %>%
    group_by(year) %>%
    summarize(
      r_squared = summary(lm(as.formula(all_vars_formula), data = cur_group()))$r.squared,
      explanatory_variable = "all_variables",
      model_type = "full",
      .groups = 'drop'
    )
  
  # Combine results
  bind_rows(individual_results, full_results) %>%
    mutate(
      r_squared = round(r_squared, 3),
      outcome_variable = outcome_var
    )
}



# variables to loop through
explanatory_variables <- c("occ10_c", "realinc_c", "degree", "finrela")
outcome_variables <- c("class_1", "class_2", "class_3", "class_4")

# subsetting data so that module doesn't crash
GSS_data_for_regressions <- GSS_data %>%
  select(all_of(explanatory_variables), all_of(outcome_variables), "year")


# Calculate R-squared trends for all classes
r2_trends <- map_dfr(outcome_variables, ~return_r2_trends(GSS_data_for_regressions, .x, explanatory_variables))

```


```{r}
ggplot(r2_trends, aes(x = year, y = r_squared, color=explanatory_variable)) +
  geom_point() +
  geom_smooth(method = "loess") +
  facet_wrap(~outcome_variable, 
    labeller = as_labeller(c(
      "class_1" = "Lower",
      "class_2" = "Working",
      "class_3" = "Middle",
      "class_4" = "Upper"
    ))) +
  theme(text = element_text(family = "Times New Roman")) +
  theme_bw() +
  theme(axis.text = element_text(size = 15)) +
  theme(axis.text.x = element_text(angle=45, hjust=1, size=12)) +
  theme(axis.title = element_text(size = 15)) +
  theme(legend.text = element_text(size = 15)) + 
  theme(legend.title = element_text(size = 15)) +
  labs(
    x = "Year",
    y = "R-squared",
    color = "Feature Set"
  ) + 
  scale_color_discrete(labels = c(
  "all_variables" = "All Variables",
  "degree" = "Education",
  "finrela" = "Perceived Income",
  "occ10_c" = "Occupation",
  "realinc_c" = "Real Income"
)) +
  theme(
    panel.spacing.x = unit(0.65, "cm")  # Increase space between facets so labels don't overlap
  )


ggsave(paste0(figure_save_path, "/r2_trends_over_time.pdf"), width = 10, height = 8)



```